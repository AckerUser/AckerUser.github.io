---
layout: post
title: 分布式系统设计
date: 2022-05-15
tags: 分布式
---

# 分布式系统设计

## 分布式系统存储

数据存储、数据分片、数据复制、数据副本、数据容错、数据一致性、协议算法

### Hash取模算法

保证数据均匀分布、实现起来简单，但不利于系统扩展

### 一致性Hash分片

将存储节点和数据都映射到一个首位相连的哈希环上，存储节点可以根据IP地址进行Hash计算，数据的存储位置是从数据映射在环上的位置开始，依次顺时针方向所找到的第一个存储节点

保存数据的均匀分布、利于系统扩展，但不利于单一热点问题

### （range）范围分片

基于分片元数据，请求分片元数据获取的信息也不仅仅只有数据分片信息，还包括数据量、读写QPS和分片副本的健康状态

问题：如果保证分片元数据服务的可用性和数据一致性

解决：专门给元数据做一个服务集群，并通过一致性算法复制数据

1. 给分片元数据做集群服务，并通过ETCD存储数据分片信息
2. 每个数据存储实例节点定时向元数据服务集群同步心跳和分片信息
3. 当调用端的请求过来，元数据服务节点只需要做好高可用和缓存即可

ETCD实现高可靠的基础在于Raft算法，也是理解ETCD工作原理最重要的一部分。类似于zookeeper的zab协议（Paxos算法），[Raft](https://www.jianshu.com/p/5aed73b288f7)也是用于保证分布式环境下多节点数据的一致性，但更易于理解。

## 分布式事务

解决：两阶段提交协议（2PC）、3PC、TCC和基于消息队列

基于消息队列：Kafka消息队列

1. 生成消息时保证事务性（B端基于MySQL保证、C端基于缓存架构）
2. 消费消息时不进行自动提交（保证消息可消费能力）
3. 对于失败消息，进行数据库落盘定时器重试机制（超过一定次数时进行人工干预）

## 分布式锁

分布式锁时解决协调分布式系统之间，同步访问共享资源的一种方式，在分布式环境下，多个系统在同时操作共享资源时发起操作的系统，通常会通过一种方式去协调其他系统，然后获取访问权限得到访问权限才可以写入数据，其他系统必须等待权限释放

#### 基于关系型数据库MySQL实现

做法如下：先查询数据库是否存在记录，为了防止幻读去通过数据库行锁select for update锁住这行数据，然后将查询和插入的SQL在同一个事务中提交

#### 基于分布式缓存Redis实现

set lock_key unique_value NX PX 10000

lock_key: key键

unique：客户端唯一标识

NX：只有key键不存在时，才对key进行设置操作

PX：过期时间，这是为了避免客户端发送异常而无法释放锁

解锁过程：将key键删除，

选用Lua脚本为了保证解锁操作的原子性

### 分布式锁的问题

可用性：无论何时都要保证锁服务的可用性

死锁问题：客户端一定可以获取锁，即使锁住某个资源的客户端在释放锁之前崩溃或者网络不可达

集群同步时产生的数据不一致性，导致新的进程有可能拿到锁，但之前的进程以为自己还有锁，那么就出现两个进程拿到了同一个锁的问题

### 分布式锁的四种设计原则

互斥性：锁获取的排他性

高可用：客户端获取锁服务的可用性

锁释放：某一个客户端获取锁的之后释放

可重入：相同客户端获取锁之后的，后续锁操作的使用
